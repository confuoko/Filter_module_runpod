# Документация по проекту очистки аудио

## Описание

Этот проект предназначен для очистки аудиофайлов с использованием модели Demucs. Он принимает аудиофайл, обрабатывает его с помощью предварительно обученной модели Demucs, очищая голосовую дорожку, и затем сохраняет результат в облачное хранилище (S3). Также предусмотрен функционал для отправки очищенных файлов в сервис транскрибации для дальнейшей обработки.

## Функции

- **Загрузка аудиофайла из хранилища**: Аудиофайл загружается из облачного хранилища S3.
- **Оценка длительности аудиофайла**: Перед обработкой рассчитывается длительность файла.
- **Очистка аудиофайла**: Используется модель Demucs для удаления шума и сохранения голосовой дорожки.
- **Загрузка очищенного файла в S3**: Очищенный файл загружается обратно в облачное хранилище.
- **Отправка на транскрибацию**: После очистки файл отправляется в сервис транскрибации для дальнейшей обработки.
- **Обновление записи в базе данных**: Длительность файла и имя очищенного файла сохраняются в базе данных.

## Установка

### Требования

- Python 3.8+
- Библиотеки:
  - `boto3` (для работы с S3)
  - `torch` (для работы с моделью Demucs)
  - `requests` (для отправки запросов)
  - `pydub` (для работы с аудиофайлами)
  - `psycopg2` (для работы с базой данных)
  - `dotenv` (для работы с переменными окружения)
  - `demucs` (для модели демикса)

### Шаги установки

1. Клонируйте репозиторий:
   ```bash
   git clone <url-репозитория>
   cd <папка-проекта>


Как работает обработка
1. Загрузка файла из S3
Аудиофайл загружается из облачного хранилища S3 в локальную временную папку. Далее рассчитывается его длительность.

python
Копировать
file_obj = s3.get_object(Bucket=bucket_name, Key=file_key)
temp_file_path = os.path.join(temp_dir, file_key)

with open(temp_file_path, 'wb') as temp_file:
    temp_file.write(file_obj['Body'].read())

# Оценка длительности
duration = get_audio_duration(temp_file_path)
2. Очистка аудиофайла с помощью Demucs
Если флаг do_clean равен True, файл очищается с использованием модели Demucs. Очищенный файл сохраняется в временной директории и затем загружается обратно в S3.

python
Копировать
if do_clean:
    cleaned_file_path = do_clean_file(temp_file_path)
    s3.upload_file(Filename=cleaned_file_path, Bucket=bucket_name, Key=cleaned_file_name)
    update_cleaned_record(item_id, duration, cleaned_file_name)
3. Отправка файла на транскрибацию
После очистки файл отправляется в сервис транскрибации для дальнейшей обработки.

python
Копировать
data = {
    'input': {
        "file_key": cleaned_file_name,
        "item_id": item_id
    }
}

response = requests.post(f'https://api.runpod.ai/v2/{TRANSCRIBATOR_QUEUE}/run', headers=headers, json=data)
4. Обновление записи в базе данных
После завершения обработки длительность файла и имя очищенного файла сохраняются в базе данных.

python
Копировать
update_cleaned_record(item_id, duration, cleaned_file_name)
5. Удаление временных файлов
После обработки очищенные и временные файлы удаляются.

python
Копировать
os.remove(cleaned_file_path)
os.remove(temp_file_path)
shutil.rmtree(demux_useful_path)
Основные функции
1. do_clean_file
Функция для обработки аудиофайла с помощью модели Demucs, удаления шума и извлечения голосовой дорожки.

python
Копировать
def do_clean_file(temp_file_path: str) -> Optional[str]:
    ...
2. get_audio_duration
Функция для получения длительности аудиофайла.

python
Копировать
def get_audio_duration(file_path: str) -> float:
    ...
3. update_cleaned_record
Функция для обновления записи в базе данных с информацией о длительности и имени очищенного файла.

python
Копировать
def update_cleaned_record(record_id, audio_length, name_file_cleaned):
    ...
4. load_demucs_model
Загружает модель Demucs, если она не найдена локально, скачивает её.

python
Копировать
def load_demucs_model(model_name="htdemucs"):
    ...
Лицензия
Этот проект лицензирован под лицензией MIT — смотрите файл LICENSE для подробностей.